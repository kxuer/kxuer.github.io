(window.webpackJsonp=window.webpackJsonp||[]).push([[81],{407:function(l,v,_){"use strict";_.r(v);var i=_(4),s=Object(i.a)({},(function(){var l=this,v=l._self._c;return v("ContentSlotsDistributor",{attrs:{"slot-key":l.$parent.slotKey}},[v("p",[l._v("存储设备通常被划分为两种类型：块设备和裸闪存设备（raw flash devices），它们分别由不同的子系统和文件系统处理。")]),l._v(" "),v("ul",[v("li",[v("strong",[l._v("块设备")]),l._v("：能以随机方式读写，且读写前不用擦除。包括硬盘、RAM disk；USB keys, SSD, SD cards, eMMC。")]),l._v(" "),v("li",[v("strong",[l._v("裸闪存设备")]),l._v("：由SoC中的控制器驱动，可读写，但写之前需要先擦除。包括NOR闪存，NAND闪存。")])]),l._v(" "),v("p",[l._v("块设备：")]),l._v(" "),v("ul",[v("li",[l._v("查看所有的块设备：\n"),v("ul",[v("li",[l._v("保存在/proc/partitions：cat /proc/partitions")]),l._v(" "),v("li",[l._v("/sys/block/也保存有块设备的信息。")])])]),l._v(" "),v("li",[l._v("分区：\n"),v("ul",[v("li",[l._v("目的是存储系统的不同部分。")]),l._v(" "),v("li",[l._v("分区表存储在设备中，由Linux内核读取并解析。如mmcblk0是整个设备，mmcblk0p2是mmcblk0的第二个分区。")]),l._v(" "),v("li",[l._v("分区表格式：\n"),v("ul",[v("li",[l._v("MBR：老版本使用的。")]),l._v(" "),v("li",[l._v("GPT：新格式，支持大小大于2TB的硬盘。")])])]),l._v(" "),v("li",[l._v("修改分区的工具：fdisk, cfdisk, sfdisk, parted, etc.")])])]),l._v(" "),v("li",[l._v("传输数据到块设备的原始方法：不经过文件系统层面，特别是用于把文件系统镜像写入块设备。\n"),v("ul",[v("li",[l._v("/dev/中的块设备允许这种原始访问方法。")]),l._v(" "),v("li",[l._v("dd (disk duplicate)工具：\n"),v("ul",[v("li",[l._v("dd if=/dev/mmcblk0p1 of=testfile bs=1M count=16：从/dev/mmcblk0p1传输16个1MB大小的块数据到testfile。")]),l._v(" "),v("li",[l._v("dd if=testfile of=/dev/sda2 bs=1M seek=4：把testfile中的数据全部传输到/dev/sda2，一次传输1MB大小的块，且从/dev/sda2中偏移量为4MB的位置开始存放。")]),l._v(" "),v("li",[l._v("常犯错误：没挂载到文件系统前，就想把一个不是文件系统镜像的文件复制到"),v("em",[l._v("文件系统")]),l._v("中，如dd if=zImage of=/dev/sde1。应该这样：sudo mount /dev/sde1 /boot；cp zImage /boot/")])])])])])]),l._v(" "),v("p",[l._v("可用的块文件系统：")]),l._v(" "),v("ul",[v("li",[l._v("文件系统格式：ext{2,3,4}\n"),v("ul",[v("li",[l._v("ext3：相对ext2引入了日志功能（所以也叫日志文件系统）。\t\t-")]),l._v(" "),v("li",[l._v("ext4：主要提升了性能，支持更大的分区。")]),l._v(" "),v("li",[l._v("Linux所需要用做根文件系统的特性都支持：权限、权属、设备文件、符号链接等等。")])])]),l._v(" "),v("li",[l._v("日志文件系统：写请求会被先写入日志中，再提交到文件，这样即使系统崩溃也能恢复数据。![[Pasted image 20230305221106.png]] ![[Pasted image 20230305221317.png]]\n"),v("ul",[v("li",[l._v("其他日志文件系统：\n"),v("ul",[v("li",[l._v("XFS：红帽企业级Linux的默认文件系统。")]),l._v(" "),v("li",[l._v("JFS：目前不活跃了，主要用于兼容了。reiserFS：目前不活跃了。")])])])])]),l._v(" "),v("li",[l._v("其他读写文件系统：\n"),v("ul",[v("li",[l._v("Btrfs：一个copy-on-write（非日志型）文件系统；包含数据校验、集成卷管理、快照等特性。")]),l._v(" "),v("li",[l._v("F2FS: Flash-Friendly Filesystem；A log-structured filesystem；支持透明压缩(LZO, LZ4, zstd)和加密。")])])]),l._v(" "),v("li",[l._v("只读文件系统：\n"),v("ul",[v("li",[l._v("SquashFS：多用于内核、二进制程序等等；用在CD、USB；支持多种压缩算法(LZO, XZ, etc.)。")]),l._v(" "),v("li",[l._v("EROFS。")])])]),l._v(" "),v("li",[l._v("选择文件系统的建议：\n"),v("ul",[v("li",[l._v("分区较小，内存较小的系统：选ext2。")]),l._v(" "),v("li",[l._v("读/写文件系统：一般用ext4，如果还需要考虑其他性能问题，考虑使用btrfs和F2FS。")])])]),l._v(" "),v("li",[l._v("文件系统兼容性：Linux还支持其他几种文件系统，目的是为了能够与其他操作系统互操作。\n"),v("ul",[v("li",[l._v("vfat：用于兼容FAT文件系统（多用于Windows和可移除设备）。\n"),v("ul",[v("li",[l._v("用来存放bootloader二进制文件也很方便（主要是FAT容易被ROM代码理解）。")]),l._v(" "),v("li",[l._v("该文件系统不支持权限、权属、符号链接等特性，因此不能用作Linux根文件系统。")]),l._v(" "),v("li",[l._v("Linux目前也支持exFAT文件系统。")])])]),l._v(" "),v("li",[l._v("ntfs：用于兼容Windows NTFS文件系统。")]),l._v(" "),v("li",[l._v("hfs：用于兼容MacOS HFS文件系统。")])])]),l._v(" "),v("li",[l._v("tmpfs：位于内存的文件系统。\n"),v("ul",[v("li",[l._v("不是块文件系统。")]),l._v(" "),v("li",[l._v("常用于在内存中存放临时数据：系统日志文件、连接数据、临时文件......")]),l._v(" "),v("li",[l._v("比ramdisks的空间效率更高。")]),l._v(" "),v("li",[l._v("使用方法：选个与其他tmpfs实例不同的名字，如mount -t tmpfs run /run，mount -t tmpfs shm /dev/shm")])])])]),l._v(" "),v("p",[l._v("使用块文件系统：")]),l._v(" "),v("ul",[v("li",[l._v("创建ext2/ext4文件系统：\n"),v("ul",[v("li",[l._v("在块设备或镜像文件中创建空文件系统：mkfs.ext4 /dev/sda3，mkfs.ext2 disk.img")]),l._v(" "),v("li",[l._v("从包含文件和文件夹的目录 创建文件系统：\n"),v("ul",[v("li",[l._v("有些文件系统有现成工具：\n"),v("ul",[v("li",[l._v("ext2: genext2fs -d rootfs/ rootfs.img")]),l._v(" "),v("li",[l._v("squashfs: mksquashfs rootfs/ rootfs.sqfs")])])]),l._v(" "),v("li",[l._v("对于其他读写文件系统：创建磁盘镜像、格式化它、挂载它、复制文件、最后卸载它。\n"),v("ul",[v("li",[l._v("如何挂载文件系统镜像：使用"),v("strong",[l._v("loop")]),l._v("机制。\n"),v("ul",[v("li",[l._v("例mkdir /tmp/tst，mount -t ext2 -o loop rootfs.img /tmp/tst。")]),l._v(" "),v("li",[l._v("那么在/tmp/tst目录就可以访问、修改rootfs.img文件中的内容了。")]),l._v(" "),v("li",[l._v("loop：一个把镜像文件模拟成块设备的内核驱动。")]),l._v(" "),v("li",[l._v("最新版的mount命令不添加-o loop也许，但BusyBox中还要添加。")])])]),l._v(" "),v("li",[l._v("如何访问磁盘镜像中的分区：losetup命令可以手动把镜像文件模拟成loop块设备，其--partscan选项还可以根据镜像中的分区创建对应的块设备文件。"),v("div",{staticClass:"language-console line-numbers-mode"},[v("pre",{pre:!0,attrs:{class:"language-text"}},[v("code",[l._v("$ sudo losetup -f --show --partscan disk.img \n/dev/loop2\n$ ls -la /dev/loop2*  \nbrw-rw---- 1 root disk 7, 2 Jan 14 10:50 /dev/loop2 \nbrw-rw---- 1 root disk 259, 11 Jan 14 10:50 /dev/loop2p1 \nbrw-rw---- 1 root disk 259, 12 Jan 14 10:50 /dev/loop2p2\n")])]),l._v(" "),v("div",{staticClass:"line-numbers-wrapper"},[v("span",{staticClass:"line-number"},[l._v("1")]),v("br"),v("span",{staticClass:"line-number"},[l._v("2")]),v("br"),v("span",{staticClass:"line-number"},[l._v("3")]),v("br"),v("span",{staticClass:"line-number"},[l._v("4")]),v("br"),v("span",{staticClass:"line-number"},[l._v("5")]),v("br"),v("span",{staticClass:"line-number"},[l._v("6")]),v("br")])]),v("ul",[v("li",[l._v("后面就可以单独访问某个分区了：如mount /dev/loop2p2 /mnt/rootfs")])])])])])])])])]),l._v(" "),v("li",[l._v("创建squashfs文件系统：\n"),v("ul",[v("li",[l._v("需要安装squashfs-tools包。")]),l._v(" "),v("li",[l._v("只能创建镜像，因为是只读的，创建空文件系统没意义。\n"),v("ul",[v("li",[l._v("mksquashfs data/ data.sqfs -noappend，-noappend表示每次都重新创建，而不是追加。")])])]),l._v(" "),v("li",[l._v("挂载：在主机上mount -o loop data.sqfs /mnt；在目标板上"),v("code",[l._v("mount /dev/<device> /mnt")]),l._v("。")])])]),l._v(" "),v("li",[l._v("同时使用只读文件系统和读写文件系统，把块存储设备划分为：![[Pasted image 20230306104722.png]]\n"),v("ul",[v("li",[l._v("一个压缩的、只读分区（SquashFS）：通常用作根文件系统（二进制、内核......）。")]),l._v(" "),v("li",[l._v("一个读写分区：通常用作日志文件系统（如ext4），用来存放用户数据、配置数据。")]),l._v(" "),v("li",[l._v("RAM存储设备用于存放临时数据（tmpfs）。")])])])]),l._v(" "),v("p",[l._v("闪存设备和文件系统：")]),l._v(" "),v("ul",[v("li",[l._v("Single Level Cell - "),v("strong",[l._v("SLC")]),l._v(": 1 bit per cell, "),v("strong",[l._v("MLC")]),l._v(": multiple bits per cell")]),l._v(" "),v("li",[l._v("NAND闪存的局限：可靠性、生命周期。但因为成本低、容量大、良好的读写性能，被广泛运用于嵌入式系统中。![[Pasted image 20230306110845.png]]")]),l._v(" "),v("li",[l._v("MTD（Memory Technology Devices）子系统：![[Pasted image 20230306111203.png]]\n"),v("ul",[v("li",[l._v("特点：\n"),v("ul",[v("li",[l._v("主要是和那些无法用块子系统处理的存储媒介打交道。")]),l._v(" "),v("li",[l._v("支持的媒介类型：RAM, ROM, NOR flash, NAND flash, Dataflash...")]),l._v(" "),v("li",[l._v("与通信接口无关（驱动可用于并行线、SPI、直接内存映射DMA......）。")]),l._v(" "),v("li",[l._v("提供了访问MTB设备的API。")])])]),l._v(" "),v("li",[l._v("MTD设备分区：与块设备不同，其分区描述放在外部（主要是因为MTB设备可靠性差些）。\n"),v("ul",[v("li",[l._v("通过开发板设备树指定。")]),l._v(" "),v("li",[l._v("通过内核命令行指定：mtdparts参数。")]),l._v(" "),v("li",[l._v("每个分区成为独立的MTB设备。")]),l._v(" "),v("li",[l._v("分区命名方式与块设备不同：从零开始，如/dev/mtd0、/dev/mtd1")])])])])]),l._v(" "),v("li",[l._v("管理闪存设备：\n"),v("ul",[v("li",[l._v("从U-Boot：help nand，nand info, nand read, nand write, nand erase...")]),l._v(" "),v("li",[l._v("从Linux：\n"),v("ul",[v("li",[l._v("mtdchar驱动：每个分区都有一个/dev/mtdX和/dev/mtdXro字符设备。")]),l._v(" "),v("li",[l._v("通过ioctl()操作。")]),l._v(" "),v("li",[l._v("使用位于mtd-utils包的工具：flash_eraseall, nandwrite。主机上的mtd-utils包还有这些工具：mkfs.jffs2, mkfs.ubifs, ubinize...")])])])])]),l._v(" "),v("li",[l._v("闪存耗损均衡（Flash wear leveling）：在没有wear leveling的情况下，某些block很可能会被频繁的反复擦写，最终报废，降低了闪存的寿命。Wear Leveling技术就是将擦写操作均摊到各个block，以防止某些block被提前耗尽使用寿命。"),v("a",{attrs:{href:"https://zhuanlan.zhihu.com/p/110607018",target:"_blank",rel:"noopener noreferrer"}},[l._v("zhihu"),v("OutboundLink")],1),l._v(" "),v("ul",[v("li",[l._v("可在文件系统层面实现(JFFS2, YAFFS2, ...)")]),l._v(" "),v("li",[l._v("可通过专门用于耗损均衡的中间层实现(UBI)")])])]),l._v(" "),v("li",[l._v("闪存文件系统：依赖MTD层访问闪存芯片。\n"),v("ul",[v("li",[l._v("以前用JFFS2, YAFFS2，用于小分区。")]),l._v(" "),v("li",[l._v("现在多用UBI/UBIFS，用在中大容量的NAND闪存中。![[Pasted image 20230306114904.png]]\n"),v("ul",[v("li",[l._v("UBI（Unsorted Block Images）：\n"),v("ul",[v("li",[l._v("优点：把耗损均衡和文件系统层分离，增加了灵活性；专注于可扩展性、性能和可靠性。")]),l._v(" "),v("li",[l._v("缺点：占用空间更多。因此在小的MTB分区，也还使用JFFS2。")]),l._v(" "),v("li",[l._v("在MTB设备之上实现了逻辑卷的功能（类似块设备中的LVM）。")]),l._v(" "),v("li",[l._v("允许在整个设备进行耗损均衡，而不单单是在一个分区。")]),l._v(" "),v("li",[l._v("如果需要分区，请使用UBI卷，而不是MTD分区。但是有些分区还是必须为MTD分区，如bootloader。如果确实需要MTD分区，尽量把它们组织到闪存设备的开始位置（这些区域通常更可靠）。![[Pasted image 20230306162217.png]]")]),l._v(" "),v("li",[l._v("UBI镜像制作：ubinize命令。![[Pasted image 20230306162937.png]]")])])]),l._v(" "),v("li",[l._v("UBIFS（Unsorted Block Images File System）：比JFFS2提供了更好的性能、且解决了其控制问题的日志文件系统。\n"),v("ul",[v("li",[l._v("可以被挂载为根文件系统。")]),l._v(" "),v("li",[l._v("UBIFS镜像制作方法：使用mtd-utils包中的mkfs.ubifs工具。")]),l._v(" "),v("li",[l._v("UBIFS镜像可以被烧写到一个卷中，或者包含在UBI镜像中（使用ubinize命令）")])])]),l._v(" "),v("li",[l._v("块模拟层：\n"),v("ul",[v("li",[l._v("有时候需要该层来使用只读块文件系统，如Squashfs和EROFS。")]),l._v(" "),v("li",[l._v("Linux提供了两个块模拟层：\n"),v("ul",[v("li",[l._v("mtdblock：在MTB设备之上模拟块设备。\n"),v("ul",[v("li",[l._v("每个分区命名为/dev/mtdblockX。")]),l._v(" "),v("li",[l._v("不要往mtdblock设备写入：不会处理坏块。")])])]),l._v(" "),v("li",[l._v("ubiblock：在UBI卷之上模拟只读块设备。\n"),v("ul",[v("li",[l._v("用在只读卷上。")]),l._v(" "),v("li",[l._v("命名为/dev/ubiblockX_Y，X是UBI设备ID，Y是UBI卷ID。")])])])])])])])])])])])])])}),[],!1,null,null,null);v.default=s.exports}}]);